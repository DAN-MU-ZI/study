# 코드 리펙터링 보고서

## 1. 변경안 개요
코드 복잡성이 비대했기 때문에 간소화 작업을 진행했습니다. 결과적으로 RPS는 약 500 수준으로 이전보다 2배 가까이 오른 상태입니다. 블룸 필터, 과도한 로깅 등 절차 상에 복잡성이 많아 구조를 수정하는데 어려움이 있었습니다. 우선 현재 아키텍처는 Redis와 PostgreSQL을 사용중이므로 캐싱 전략에 대해서 재정립했습니다. Look Aside 와 Write Through를 캐싱 전략으로 적용했습니다. 고가용성 요건을 충족하기 위해 k6에 약 11,000에 달하는 RPS를 조건으로 테스트했기 때문에 캐시를 위주로 처리하도록 생각했습니다. 

## 2. 원본 테스트 로그 (Raw Test Output)

### [Refactor 테스트 결과]
```text
  █ TOTAL RESULTS

    checks_total.......: 19239   547.675206/s
    checks_succeeded...: 100.00% 19239 out of 19239
    checks_failed......: 0.00%   0 out of 19239

    ✓ Create status must be 200
    ✓ Redirect status must be 301 or 302

    HTTP
    http_req_duration..............: avg=1.67s  min=3.25ms med=831.87ms max=28.44s p(90)=3.55s p(95)=6.33s
      { expected_response:true }...: avg=1.67s  min=3.25ms med=831.87ms max=28.44s p(90)=3.55s p(95)=6.33s
    http_req_failed................: 0.00%  0 out of 19239
    http_reqs......................: 19239  547.675206/s

    EXECUTION
    dropped_iterations.............: 28252  804.247618/s
    iteration_duration.............: avg=18.48s min=2.53s  med=17.24s   max=34.12s p(90)=32.9s p(95)=33.9s
    iterations.....................: 1749   49.788655/s
    vus............................: 249    min=249        max=1000
    vus_max........................: 1000   min=1000       max=1000

    NETWORK
    data_received..................: 4.2 MB 120 kB/s
    data_sent......................: 1.8 MB 52 kB/s




running (0m35.1s), 0000/1000 VUs, 1749 complete and 0 interrupted iterations
load_test ✓ [ 100% ] 0000/1000 VUs  30s  1000.00 iters/s
```

## 3. 성능 비교 및 분석

기존 복잡한 로직을 걷어내고 Look Aside/Write Through 캐싱 전략을 적용한 결과, 주요 지표에서 유의미한 성능 향상을 확인했습니다.

| 비교 지표 | 기존 (k6_load_test_results.md) | 리펙터링 후 (현재) | 변화율 |
| :--- | :--- | :--- | :--- |
| **초당 처리량 (RPS)** | **253.57 req/s** | **547.67 req/s** | **+115.98% 향상** |
| **평균 응답 시간 (Avg)** | **3.44s** | **1.67s** | **51.45% 감소 (개선)** |
| **95% 응답 시간 (P95)** | **8.09s** | **6.33s** | **21.75% 감소 (개선)** |
| **총 처리 요청 수** | 11,616 | 19,239 | +65.62% 증가 |
| **성공률 (Success Rate)** | 100.00% | 100.00% | 유지 |

### 3.1 주요 분석 포인트
1.  **처리량(RPS) 2배 이상 향상**: 부가적인 로직(블룸 필터, 과도한 로그 기록 등)을 제거하고 캐싱 레이어에 집중함으로써 동일한 리소스에서 처리할 수 있는 초당 요청 수가 약 **2.16배** 증가했습니다.
2.  **응답 속도 개선**: 평균 응답 시간이 3.44초에서 1.67초로 절반 이하로 줄어들었습니다. 이는 데이터베이스 조회 빈도를 줄이고 메모리 기반의 Redis 캐시를 적극 활용한 결과입니다.
3.  **지연 시간 안정성**: P95 지연 시간 역시 개선되었으나, 최대 응답 시간(Max)은 28.44s로 다소 높게 측정되었습니다. 이는 테스트 후반부나 특정 구간에서 컨테이너 자원 경합 또는 네트워크 병목이 발생했을 가능성을 시사하므로, 향후 커넥션 풀 최적화나 인프라 튜닝이 추가로 필요할 수 있습니다.
4.  **효율성 증대**: `dropped_iterations`는 여전히 존재하지만(28,252), 실제 처리된 요청(`http_reqs`)은 약 7,600건 이상 늘어남으로써 시스템의 실질적인 수용 능력이 개선되었습니다.

## 4. 주요 추가 사항
- uvloop, orjson, hiredis 적용